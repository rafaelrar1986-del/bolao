// middleware/blockStats.js
import Settings from '../models/Settings.js';

export async function blockStatsIfLocked(req, res, next) {
  try {
    // ðŸ”¹ 1. Admin ignora qualquer bloqueio
    if (req.user?.role === 'admin') {
      return next();
    }

    // ðŸ”¹ 2. Busca config global
    const settings = await Settings.findById('global_settings');

    if (!settings) {
      return next(); // sem config â†’ nÃ£o bloqueia
    }

    // ðŸ”¹ 3. Desbloqueio automÃ¡tico por data
    if (
      settings.statsLocked === true &&
      settings.unlockAt &&
      new Date() >= settings.unlockAt
    ) {
      settings.statsLocked = false;
      settings.lockedReason = null;
      settings.unlockAt = null;
      await settings.save();
      return next();
    }

    // ðŸ”¹ 4. Se estatÃ­sticas estiverem bloqueadas
    if (settings.statsLocked === true) {
      return res.status(423).json({
        success: false,
        code: 'STATS_LOCKED',
        reason: settings.lockedReason || 'PRE_TOURNAMENT'
      });
    }

    next();
  } catch (err) {
    console.error('Erro blockStatsIfLocked:', err);
    next(); // nunca derruba o sistema
  }
}
